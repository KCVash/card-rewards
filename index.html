<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>信用卡回饋查詢</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; margin: 24px; line-height: 1.4; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input { padding: 10px 12px; font-size: 16px; width: min(420px, 100%); }
    button { padding: 10px 12px; font-size: 16px; cursor: pointer; }
    .hint { color: #555; margin-top: 6px; }
    .list { margin-top: 16px; display: grid; gap: 10px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px 14px; }
    .top { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; }
    .name { font-weight: 700; }
    .reward { font-weight: 800; font-size: 18px; }
    .note { color: #444; margin-top: 6px; }
    .meta { color: #666; font-size: 13px; margin-top: 2px; }
    .empty { color: #666; margin-top: 16px; }
  </style>
</head>
<body>
  <h1>信用卡回饋查詢（MVP）</h1>

  <div class="row">
    <input id="q" placeholder="輸入通路，例如：7-11、餐飲、海外…" />
    <button id="btn">查詢</button>
  </div>
  <div class="hint">規則：只比對 merchant（完全相等），依 reward 由高到低排序。</div>

  <div id="result" class="list"></div>
  <div id="empty" class="empty" style="display:none;"></div>

<script>
  let rules = [];

  async function loadData() {
    const res = await fetch('./cards.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('讀取 cards.json 失敗');
    rules = await res.json();
  }

  function norm(s) { return (s ?? '').toString().trim().toLowerCase(); }

  function render(items, query) {
    const result = document.getElementById('result');
    const empty = document.getElementById('empty');
    result.innerHTML = '';
    empty.style.display = 'none';

    if (!items.length) {
      empty.textContent = `找不到「${query}」的回饋資料（或你尚未在 cards.json 填這個通路）。`;
      empty.style.display = 'block';
      return;
    }

    for (const it of items) {
      const el = document.createElement('div');
      el.className = 'card';
      const r = Number(it.reward || 0);
      el.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${it.bank}｜${it.card}</div>
            <div class="meta">通路：${it.merchant}</div>
          </div>
          <div class="reward">${r.toFixed(2).replace(/\.00$/,'')}%</div>
        </div>
        ${it.note ? `<div class="note">備註：${it.note}</div>` : ``}
      `;
      result.appendChild(el);
    }
  }

  function search() {
    const q = document.getElementById('q').value.trim();
    const nq = norm(q);
    if (!nq) return;

    const items = rules
      .filter(r => norm(r.merchant) === nq)
      .sort((a, b) => (Number(b.reward || 0) - Number(a.reward || 0)));

    render(items, q);
  }

  document.getElementById('btn').addEventListener('click', search);
  document.getElementById('q').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') search();
  });

  (async () => {
    try { await loadData(); }
    catch (err) {
      const empty = document.getElementById('empty');
      empty.textContent = '初始化失敗：' + err.message;
      empty.style.display = 'block';
    }
  })();
</script>
</body>
</html>
